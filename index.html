<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>íŒŒíŠ¸ë„ˆìŠ¤ ì˜ì—…ì§€ì›</title>

    <!-- ========================================== -->
    <!-- [í•„ìˆ˜ ì„¤ì •] êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ì•± URL ì…ë ¥ -->
    <!-- ========================================== -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzLj2pOu3gG1p8HhPC-t36bEwImkIFNfb9FAcO7WI3F_UP9wp6DsnCyUKUGBGtOT6BpTA/exec';
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#F37321', // Orange
                        primaryHover: '#d96316',
                        secondary: '#1e293b', // Dark Blue/Gray
                        brandNavy: '#1B1F3B', // Deep Navy for Left Panel
                    },
                    animation: {
                        blob: "blob 7s infinite",
                        fadeIn: "fadeIn 0.5s ease-out forwards",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        },
                        fadeIn: {
                            "0%": { opacity: "0", transform: "translateY(10px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" },
                        },
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background-color: #f8fafc;
        }

        .loader {
            border-top-color: #F37321;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .truncate-product {
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Mobile FAB (Floating Action Button) */
        .mobile-fab-container {
            position: fixed;
            right: 16px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .fab-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #F37321;
            color: #FFFFFF;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
            cursor: pointer;
        }

        .fab-btn:hover {
            background-color: #d96316;
            transform: translateY(-2px);
        }

        .fab-btn:active {
            background-color: #d96316;
            transform: translateY(0);
        }

        .fab-icon {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
            line-height: 1;
        }

        .fab-text {
            font-size: 10px;
            line-height: 1;
        }

        @media (min-width: 769px) {
            .mobile-fab-container {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans antialiased text-sm md:text-base">
    <div id="error-log"
        style="display:none; color: white; padding: 12px; background: #ef4444; z-index:9999; position:fixed; top:0; left:0; width:100%; text-align:center; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    </div>

    <!-- Loading Spinner -->
    <div id="loading"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-fadeIn">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-3"></div>
            <p class="text-gray-500 text-sm font-medium">Loading...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col transition-colors duration-500">
        <div id="content" class="flex-grow flex flex-col w-full h-full"></div>
    </div>

    <!-- Password Change Modal -->
    <div id="pw-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm transform transition-all scale-100 animate-fadeIn text-center">
            <div class="text-center mb-6">
                <div
                    class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <p class="text-sm text-gray-500 mt-1">ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.</p>
            </div>

            <form id="pwForm" class="space-y-4 text-left">
                <div>
                    <input type="password" id="newPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬ ì´ìƒ)"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-primary focus:ring-2 focus:ring-orange-100 outline-none transition"
                        required>
                </div>
                <div>
                    <input type="password" id="confirmPw" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-primary focus:ring-2 focus:ring-orange-100 outline-none transition"
                        required>
                </div>
                <div class="flex justify-between gap-3 mt-6">
                    <button type="button" id="pwCancelBtn" onclick="closePwModal()"
                        class="flex-1 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition">ì·¨ì†Œ</button>
                    <button type="submit"
                        class="flex-1 px-4 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primaryHover shadow-lg shadow-orange-200 transition">ë³€ê²½í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 0. API Configuration ---
        async function callApi(action, ...args) {
            if (API_URL === 'INSERT_YOUR_GAS_WEB_APP_URL_HERE') {
                alert('API URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. backend_scripts.gsë¥¼ ë°°í¬í•˜ê³  URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return { error: true, message: 'API URL Not Configured' };
            }
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // 'text/plain' avoids CORS preflight OPTIONS in some cases with GAS
                    body: JSON.stringify({ action: action, args: args })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                return data;
            } catch (e) {
                console.error('API Error:', e);
                return { error: true, message: e.toString() };
            }
        }

        // --- 1. State & Utilities ---
        window.onerror = function (message) { document.getElementById('error-log').style.display = 'block'; document.getElementById('error-log').innerText = '! Error: ' + message; setTimeout(() => document.getElementById('error-log').style.display = 'none', 5000); };

        var state = {
            user: null,
            currentView: 'login',
            currentMonth: '',
            months: [],
            data: {},
            adminTab: 'reward',
            adminSubTab: 'active',
            adminPage: 1,
            pageSize: 20,
            mobileMenuOpen: false
        };

        const LOGO_TEXT = `<div class="flex items-center gap-2 select-none">
            <span class="text-2xl font-bold text-gray-800 tracking-tight">íŒŒíŠ¸ë„ˆìŠ¤ <span class="text-primary">ì˜ì—…ì§€ì›</span></span>
        </div>`;
        const LOGO_BIG = `<div class="flex flex-col items-center justify-center gap-5 text-white select-none">
            <h1 class="text-3xl font-bold tracking-widest drop-shadow-md">íŒŒíŠ¸ë„ˆìŠ¤<span class="font-light">ë³¸ë¶€</span></h1>
        </div>`;

        function showLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }
        function formatMoney(n) { return Number(n || 0).toLocaleString(); }
        function formatRate(r) {
            if (r === '' || r === null || r === undefined) return '';
            const n = Number(r);
            if (!isNaN(n)) return n.toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 1 });
            return r;
        }

        // --- 2. Navigation & History ---
        function navigate(view, push = true) {
            state.currentView = view;
            if (push) history.pushState({ view: view }, '', '#/' + view);
            state.mobileMenuOpen = false;
            render();
            // Data refresh on nav if needed
            if (view !== 'login') refresh();
        }

        window.onpopstate = function (e) {
            if (e.state && e.state.view) {
                state.currentView = e.state.view;
                render();
            } else {
                if (state.user) navigate('home', false);
                else navigate('login', false);
            }
        };

        // --- 3. Persistence & Session ---
        let sessionTimeoutTimer;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes

        function resetSessionTimer() {
            if (!state.user) return;
            clearTimeout(sessionTimeoutTimer);
            saveSession(); // Update timestamp
            sessionTimeoutTimer = setTimeout(() => {
                alert('30ë¶„ ë™ì•ˆ ì›€ì§ì„ì´ ì—†ì–´ ì•ˆì „ì„ ìœ„í•´ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                logout();
            }, SESSION_DURATION);
        }

        // Add listeners to reset timer on user interaction
        ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, resetSessionTimer, true);
        });

        function saveSession() {
            if (state.user) {
                // Use sessionStorage to clear when browser is closed
                sessionStorage.setItem('partners_session', JSON.stringify({
                    user: state.user,
                    months: state.months,
                    currentMonth: state.currentMonth,
                    timestamp: new Date().getTime()
                }));
            }
        }

        function restoreSession() {
            const s = sessionStorage.getItem('partners_session');
            if (s) {
                try {
                    const sess = JSON.parse(s);
                    // 30 minutes expiration check
                    if (new Date().getTime() - sess.timestamp < SESSION_DURATION) {
                        state.user = sess.user;
                        state.months = sess.months;
                        state.currentMonth = sess.currentMonth;
                        const hash = location.hash.replace('#/', '');
                        state.currentView = (hash && hash !== 'login') ? hash : 'home';
                        resetSessionTimer();
                        return true;
                    }
                } catch (e) { console.error('Restore failed', e); }
            }
            return false;
        }

        function clearSession() {
            clearTimeout(sessionTimeoutTimer);
            sessionStorage.removeItem('partners_session');
            history.pushState(null, '', ' ');
        }

        // --- 4. Main Render Logic ---
        window.render = function () {
            const app = document.getElementById('content');
            app.innerHTML = '';

            if (!state.user) {
                app.appendChild(createLoginView());
            } else {
                app.appendChild(createLayout());
            }
        }

        // --- 5. Views ---

        function createHomeView() {
            const div = document.createElement('div');

            // ë³´ìœ  ë°ì´í„° í™•ì¸
            const hd = state.data.homeData || { retentionRate: '-', baseMonth: '-' };
            let rateClass = 'text-primary';
            if (hd.retentionRate !== '-' && hd.retentionRate !== 'ë°ì´í„° ì—†ìŒ') {
                const num = parseFloat(hd.retentionRate);
                if (num >= 90) rateClass = 'text-blue-500';
                else rateClass = 'text-red-500'; // 90% ë¯¸ë§Œ ì‹œ ë¹¨ê°„ìƒ‰
            }

            // ê¸°ì¡´ì— ì ‘ì†í–ˆë˜ ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì € ìºì‹œì— '2026ë…„ 1ì›”' í˜•íƒœë¡œ ë‚¨ì•„ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ JSì—ì„œ í•œë²ˆ ë” í¬ë§·íŒ…
            let displayMonth = hd.baseMonth;
            if (displayMonth && displayMonth.startsWith('20')) {
                displayMonth = displayMonth.replace(/^20(\d{2}ë…„)/, '$1');
            }

            const formatUserType = () => {
                if (state.user.role === 'ì§€ì‚¬ëŒ€í‘œ') return 'ì§€ì‚¬ëŒ€í‘œ';
                if (state.user.role === 'ê´€ë¦¬ì') return 'ê´€ë¦¬ì';
                return state.user.organization || 'íŒŒíŠ¸ë„ˆìŠ¤';
            };

            div.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 tracking-tight">ì•ˆë…•í•˜ì„¸ìš”, ${state.user.name}ë‹˜ ğŸ‘‹</h2>
                    <p class="text-gray-500 text-sm mt-2 font-medium bg-gray-100 inline-block px-3 py-1 rounded-full">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
                </div>
                
                <div class="mb-12">
                    <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-sm border border-gray-100 p-8 flex flex-col justify-center">
                        <div class="flex items-center gap-2 mb-6 w-full">
                            <span class="w-1.5 h-4 bg-primary rounded-full inline-block"></span>
                            <p class="text-sm font-bold text-gray-700 tracking-wide">ë‚˜ì˜ 13íšŒì°¨ í†µì‚°ìœ ì§€ìœ¨ ${displayMonth !== '-' ? '(' + displayMonth + ' ê¸°ì¤€)' : ''}</p>
                        </div>
                        <p class="text-4xl font-extrabold ${rateClass} tracking-tight drop-shadow-sm text-center">${hd.retentionRate}</p>
                    </div>
                    <div class="flex items-center gap-1.5 mt-3 ml-2 text-gray-400">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-xs font-medium">Tip : ìœ ì§€ìœ¨ í´ë¦­ì‹œ ì§ì „ 1ë…„ë‚´ ì‹¤íš¨ê³„ì•½ ì¡°íšŒ ê°€ëŠ¥</p>
                    </div>
                </div>

                <div class="mb-5 text-lg font-bold text-gray-800 border-b border-gray-100 pb-2">ë¹ ë¥¸ ë©”ë‰´</div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div onclick="navigate('dashboard')" class="bg-white cursor-pointer hover:-translate-y-1 hover:shadow-xl hover:border-blue-100 transition-all duration-300 rounded-2xl p-6 border border-gray-100 flex flex-col items-center justify-center text-center group">
                        <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-blue-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg">ì‹œìƒê¸ˆ ì¡°íšŒ</h3>
                        <p class="text-xs text-gray-400 mt-1">ì›”ë³„ ì‹œìƒê¸ˆ ìƒì„¸ ë‚´ì—­</p>
                    </div>
                    <div class="bg-gray-50 cursor-pointer hover:bg-white hover:-translate-y-1 hover:shadow-xl hover:border-red-100 transition-all duration-300 rounded-2xl p-6 border border-gray-200 flex flex-col items-center justify-center text-center group">
                        <div class="w-16 h-16 bg-red-50 text-red-400 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-red-400 group-hover:text-white transition-colors duration-300 shadow-sm">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <h3 class="font-bold text-gray-500 text-lg">ì‹¤íš¨ì˜ˆì • ê³„ì•½ë¦¬ìŠ¤íŠ¸</h3>
                        <p class="text-xs text-red-400 font-bold mt-1">(ê°œë°œì¤‘)</p>
                    </div>
                    ${state.user.isRecruiter ? `
                    <div onclick="navigate('recruitment')" class="bg-white cursor-pointer hover:-translate-y-1 hover:shadow-xl hover:border-green-100 transition-all duration-300 rounded-2xl p-6 border border-gray-100 flex flex-col items-center justify-center text-center group">
                        <div class="w-16 h-16 bg-green-50 text-green-500 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-green-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg">ì¦ì›ìˆ˜ë‹¹ ì¡°íšŒ</h3>
                        <p class="text-xs text-gray-400 mt-1">ì‚°í•˜ ì¸ì› ë° ì¦ì›ìˆ˜ë‹¹ í˜„í™©</p>
                    </div>` : ''}
                    ${state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' ? `
                    <div onclick="navigate('branch')" class="bg-white cursor-pointer hover:-translate-y-1 hover:shadow-xl hover:border-purple-100 transition-all duration-300 rounded-2xl p-6 border border-gray-100 flex flex-col items-center justify-center text-center group">
                        <div class="w-16 h-16 bg-purple-50 text-purple-500 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-purple-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg">ì§€ì‚¬ëŒ€í‘œ</h3>
                        <p class="text-xs text-gray-400 mt-1">ë²•ì¸ ì‹œìƒ ë° ì¸ì„¼í‹°ë¸Œ</p>
                    </div>` : ''}
                    ${(state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' || state.user.role === 'ê´€ë¦¬ì') ? `
                    <div onclick="navigate('admin')" class="bg-white cursor-pointer hover:-translate-y-1 hover:shadow-xl hover:border-gray-300 transition-all duration-300 rounded-2xl p-6 border border-gray-100 flex flex-col items-center justify-center text-center group">
                        <div class="w-16 h-16 bg-gray-50 text-gray-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-gray-700 group-hover:text-white transition-colors duration-300 shadow-sm">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
                        <p class="text-xs text-gray-400 mt-1">íŒŒíŠ¸ë„ˆë³„ ì¢…í•© ì‹¤ì  í˜„í™©</p>
                    </div>` : ''}
                </div>
            `;
            return div;
        }

        function createLoginView() {
            const container = document.createElement('div');
            container.className = 'min-h-screen flex flex-col md:flex-row w-full font-sans';

            // Left Panel (Desktop Only)
            const leftPanel = document.createElement('div');
            leftPanel.className = 'hidden md:flex md:w-1/2 bg-brandNavy flex-col items-center justify-center p-12 text-center relative overflow-hidden text-white';
            leftPanel.innerHTML = `
                <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-white/5 rounded-full blur-3xl"></div>
                <div class="z-10 flex flex-col items-center gap-8 animate-fadeIn">
                    <div class="space-y-4 mb-8">
                        <h1 class="text-4xl font-bold tracking-wider">íŒŒíŠ¸ë„ˆìŠ¤ë³¸ë¶€</h1>
                        <p class="text-gray-300 text-lg font-light leading-relaxed">
                            ì„±ê³µì ì¸ ì˜ì—…ì„ ìœ„í•œ ì§€ì› í”Œë«í¼<br>
                            ì–¸ì œ ì–´ë””ì„œë‚˜ ì‰½ê³  ë¹ ë¥´ê²Œ ì¡°íšŒí•˜ì„¸ìš”
                        </p>
                    </div>

                    <div class="space-y-6 w-full max-w-sm text-left">
                        <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                            <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-base">íˆ¬ëª…í•œ ì‹œìƒê¸ˆ ì¡°íšŒ</h3>
                                <p class="text-xs text-gray-400">ì •í™•í•œ ë°ì´í„° ê¸°ë°˜ì˜ ì‹œìƒê¸ˆ ë‚´ì—­ í™•ì¸</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                            <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-base">ì²´ê³„ì ì¸ ì¦ì› ê´€ë¦¬</h3>
                                <p class="text-xs text-gray-400">ì¦ì›ìˆ˜ë‹¹ ë° ì‚°í•˜ íŒŒíŠ¸ë„ˆ í˜„í™© í™•ì¸</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                            <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-base">ê°•ë ¥í•œ ì˜ì—… ì§€ì›</h3>
                                <p class="text-xs text-gray-400">ì˜ì—… í™œë™ì— í•„ìš”í•œ ë‹¤ì–‘í•œ ì •ë³´ ì œê³µ</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Right Panel
            const rightPanel = document.createElement('div');
            rightPanel.className = 'w-full md:w-1/2 bg-white flex flex-col h-screen md:h-auto overflow-y-auto';
            rightPanel.innerHTML = `
                <div class="flex-grow flex items-center justify-center p-6 sm:p-12">
                     <div class="w-[85%] md:w-full max-w-sm space-y-10 animate-fadeIn mx-auto">
                        
                        <!-- Mobile Header Logo -->
                        <div class="md:hidden text-center mb-10 mt-16">
                            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">íŒŒíŠ¸ë„ˆìŠ¤ë³¸ë¶€</h1>
                        </div>

                        <!-- Main Title -->
                        <div class="text-center space-y-2">
                             <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight">íŒŒíŠ¸ë„ˆìŠ¤ <span class="text-primary">ì˜ì—…ì§€ì›</span></h2>
                             <p class="text-gray-400 text-sm">ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</p>
                        </div>
                        
                        <form id="loginForm" class="space-y-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700 text-left">ì‚¬ë²ˆ</label>
                                <input type="text" id="staffId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3.5 rounded-lg border border-gray-200 bg-white focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition duration-200 placeholder-gray-400 text-center" required>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-gray-700 text-left">ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3.5 rounded-lg border border-gray-200 bg-white focus:bg-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition duration-200 placeholder-gray-400 text-center" required>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-lg hover:bg-primaryHover hover:shadow-lg transition duration-200 text-lg">ë¡œê·¸ì¸</button>
                        </form>
                        
                        <div class="pt-4 text-center">
                            <p class="text-xs text-gray-400 mb-2">ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</p>
                            <p class="text-xs text-gray-400">ë¡œê·¸ì¸ì— ë¬¸ì œê°€ ìˆìœ¼ì‹œë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”</p>
                            <p class="text-xs text-gray-300 mt-8 font-light">Â© 2024 íŒŒíŠ¸ë„ˆìŠ¤ë³¸ë¶€. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(leftPanel);
            container.appendChild(rightPanel);

            setTimeout(() => {
                const form = container.querySelector('#loginForm');
                if (form) form.addEventListener('submit', e => {
                    e.preventDefault();
                    doLogin(container.querySelector('#staffId').value, container.querySelector('#password').value);
                });
            }, 0);
            return container;
        }

        function createLayout() {
            const container = document.createElement('div');
            container.className = 'flex flex-col min-h-screen bg-[#f8fafc]';

            const monthOptions = state.months.map(m => `<option value="${m}" ${m === state.currentMonth ? 'selected' : ''}>${m}</option>`).join('');

            // Desktop Selector
            const monthSel = `<div class="relative"><select id="commonMonthSelect" class="appearance-none bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg shadow-sm hover:border-gray-300 focus:ring-2 focus:ring-primary/20 focus:border-primary block pl-3 pr-8 py-2 cursor-pointer transition">
                ${monthOptions}
            </select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div></div>`;

            // Mobile Selector
            const mobileMonthSel = `<div class="relative w-full"><select id="mobileMonthSelect" class="appearance-none w-full bg-white border border-gray-200 text-gray-900 text-base rounded-xl shadow-sm focus:ring-2 focus:ring-primary/20 focus:border-primary block pl-4 pr-10 py-3 cursor-pointer transition">
                ${monthOptions}
            </select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div></div>`;

            const navLink = (v, l) => `
                <a href="#" data-nav="${v}" class="${state.currentView === v
                    ? 'text-primary border-b-2 border-primary font-bold'
                    : 'text-gray-500 hover:text-gray-800 hover:border-b-2 hover:border-gray-300 font-medium'}
                    px-1 py-5 text-sm transition-all duration-200 select-none">
                    ${l}
                </a>`;

            container.innerHTML = `
                <header class="bg-white shadow-sm sticky top-0 z-40 transition-shadow duration-300">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between h-16 relative">
                            <div class="flex">
                                <div class="absolute inset-x-0 h-16 flex items-center justify-center pointer-events-none md:static md:h-auto md:justify-start z-10">
                                    <div class="flex-shrink-0 flex items-center cursor-pointer pointer-events-auto" onclick="navigate('home')">
                                        ${LOGO_TEXT}
                                    </div>
                                </div>
                                <div class="hidden md:ml-10 md:flex md:space-x-8">
                                    ${navLink('home', 'í™ˆ')}
                                    ${navLink('dashboard', 'ì‹œìƒê¸ˆ ì¡°íšŒ')}
                                    ${state.user.isRecruiter ? navLink('recruitment', 'ì¦ì›ìˆ˜ë‹¹ ì¡°íšŒ') : ''}
                                    ${state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' ? navLink('branch', 'ì§€ì‚¬ëŒ€í‘œ') : ''}
                                    ${(state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' || state.user.role === 'ê´€ë¦¬ì') ? navLink('admin', 'ê´€ë¦¬ì') : ''}
                                </div>
                            </div>
                            <div class="hidden md:flex items-center space-x-6">
                                <div class="flex items-center">
                                    <span class="text-sm font-bold text-gray-700 mr-2">ë§ˆê°ì›”:</span>
                                    ${monthSel}
                                </div>
                                <div class="flex items-center space-x-3 pl-3 border-l">
                                   <div class="text-right leading-tight">
                                       <div class="text-sm font-bold text-gray-900">${state.user.name}<span class="font-normal text-gray-500">ë‹˜</span></div>
                                       <div class="text-[11px] text-gray-400">${state.user.organization || 'ì†Œì†'}</div>
                                   </div>
                                   <div class="flex space-x-1">
                                       <button id="changePwBtn" class="p-2 rounded-full text-gray-400 hover:text-primary hover:bg-orange-50 transition tooltip" title="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">
                                          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                                       </button>
                                       <button id="logout" class="p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition" title="ë¡œê·¸ì•„ì›ƒ">
                                          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                       </button>
                                   </div>
                                </div>
                            </div>
                            <div class="-mr-2 flex items-center md:hidden">
                                <button id="mb-btn" class="inline-flex items-center justify-center p-2 rounded-lg text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none transition">
                                    <svg class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="mobile-menu" class="md:hidden bg-white border-b border-gray-100 overflow-hidden transition-all duration-300 ease-in-out h-0 relative z-30">
                         <div class="px-4 py-4 bg-gray-50 flex items-center justify-between">
                            <div>
                                <div class="font-bold text-gray-900">${state.user.name}ë‹˜</div>
                                <div class="text-xs text-gray-500">${state.user.organization || 'ì†Œì† ë¯¸ì§€ì •'}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="openChangePasswordModal(true)" class="text-xs bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-gray-600 shadow-sm">PWë³€ê²½</button>
                                <button id="logoutM" class="text-xs bg-red-50 border border-red-100 px-3 py-1.5 rounded-lg text-red-600 shadow-sm">ë¡œê·¸ì•„ì›ƒ</button>
                            </div>
                         </div>
                         <div class="px-2 pt-2 pb-3 space-y-1">
                            <a href="#" data-nav="home" class="block px-3 py-3 rounded-xl text-base font-medium ${state.currentView === 'home' ? 'bg-orange-50 text-primary' : 'text-gray-600 hover:bg-gray-50'}">í™ˆ</a>
                            <a href="#" data-nav="dashboard" class="block px-3 py-3 rounded-xl text-base font-medium ${state.currentView === 'dashboard' ? 'bg-orange-50 text-primary' : 'text-gray-600 hover:bg-gray-50'}">ì‹œìƒê¸ˆ ì¡°íšŒ</a>
                            ${state.user.isRecruiter ? `<a href="#" data-nav="recruitment" class="block px-3 py-3 rounded-xl text-base font-medium ${state.currentView === 'recruitment' ? 'bg-orange-50 text-primary' : 'text-gray-600 hover:bg-gray-50'}">ì¦ì›ìˆ˜ë‹¹ ì¡°íšŒ</a>` : ''}
                            ${state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' ? `<a href="#" data-nav="branch" class="block px-3 py-3 rounded-xl text-base font-medium ${state.currentView === 'branch' ? 'bg-orange-50 text-primary' : 'text-gray-600 hover:bg-gray-50'}">ì§€ì‚¬ëŒ€í‘œ</a>` : ''}
                            ${(state.user.role === 'ì§€ì‚¬ëŒ€í‘œ' || state.user.role === 'ê´€ë¦¬ì') ? `<a href="#" data-nav="admin" class="block px-3 py-3 rounded-xl text-base font-medium ${state.currentView === 'admin' ? 'bg-orange-50 text-primary' : 'text-gray-600 hover:bg-gray-50'}">ê´€ë¦¬ì</a>` : ''}
                         </div>
                         <div class="p-4 border-t border-gray-100 bg-gray-50/50">
                             <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ë§ˆê°ì›” ì„ íƒ</label>
                             ${mobileMonthSel}
                         </div>
                    </div>
                    
                    <!-- Mobile Backdrop -->
                    <div id="mobile-backdrop" class="fixed inset-0 bg-black/50 z-20 hidden transition-opacity duration-300 md:hidden"></div>
                </header>

                <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 animate-fadeIn">
                     <div id="main-view"></div>
                </main>

                <!-- Mobile FAB -->
                <div class="mobile-fab-container">
                    <button type="button" class="fab-btn" onclick="navigate('home')">
                        <span class="fab-text" style="font-size: 13px; font-weight: bold;">í™ˆ</span>
                    </button>
                    <button type="button" class="fab-btn" onclick="history.back()">
                        <span class="fab-icon">â†</span>
                        <span class="fab-text">ì´ì „</span>
                    </button>
                </div>
            `;

            const main = container.querySelector('#main-view');
            // Logic reuse
            if (state.currentView === 'home') main.appendChild(createHomeView());
            else if (state.currentView === 'dashboard') main.appendChild(createDashboardView());
            else if (state.currentView === 'recruitment') main.appendChild(createRecruitmentView());
            else if (state.currentView === 'branch') main.appendChild(createBranchView());
            else if (state.currentView === 'admin') main.appendChild(createAdminView());

            setTimeout(() => {
                container.querySelectorAll('#commonMonthSelect, #mobileMonthSelect').forEach(e => e.addEventListener('change', ev => {
                    state.currentMonth = ev.target.value;
                    saveSession();
                    refresh();
                }));
                // Using event delegation for nav items to handle dynamic content safety
                container.querySelectorAll('[data-nav]').forEach(e => e.addEventListener('click', ev => {
                    ev.preventDefault();
                    navigate(ev.target.getAttribute('data-nav'));
                }));

                const mbBtn = container.querySelector('#mb-btn');
                const mMenu = container.querySelector('#mobile-menu');
                const backdrop = container.querySelector('#mobile-backdrop');

                const toggleMenu = () => {
                    const isOpen = mMenu.style.height === 'auto';
                    mMenu.style.height = isOpen ? '0' : 'auto';
                    if (isOpen) {
                        mMenu.classList.remove('shadow-xl', 'border-b-2', 'border-primary/10');
                        backdrop.classList.add('hidden');
                    } else {
                        mMenu.classList.add('shadow-xl', 'border-b-2', 'border-primary/10');
                        backdrop.classList.remove('hidden');
                    }
                };

                if (mbBtn) mbBtn.onclick = toggleMenu;
                if (backdrop) backdrop.onclick = toggleMenu;

                container.querySelector('#logout')?.addEventListener('click', () => logout());
                container.querySelector('#logoutM')?.addEventListener('click', () => logout());
                container.querySelector('#changePwBtn')?.addEventListener('click', () => openChangePasswordModal(true));
            }, 0);
            return container;
        }

        function createDashboardView() {
            const div = document.createElement('div');
            const d = state.data.rewardData?.summary || {};
            const keys = ['ì†ë³´ ì‹œìƒê¸ˆ', 'ìƒë³´ ì‹œìƒê¸ˆ', 'ë³¸ë¶€ ì‹œìƒê¸ˆ'];
            let totalPay = 0, totalRef = 0;
            keys.forEach(k => {
                const obj = d[k] || { pay: 0, refund: 0 };
                totalPay += obj.pay; totalRef += obj.refund;
            });
            const net = totalPay + totalRef;

            const card = (label, val, color, isRed = false, big = false) => `
              <div class="bg-white rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 p-6 border-l-[6px] ${color} h-full flex flex-col justify-center items-center text-center group">
                 <p class="text-gray-400 text-xs font-bold uppercase tracking-wider group-hover:text-gray-600 transition-colors mb-2">${label}</p>
                 <p class="${big ? 'text-2xl' : 'text-xl'} font-extrabold ${isRed || (val < 0) ? 'text-red-500' : 'text-gray-800'} tracking-tight">${formatMoney(val)}</p>
              </div>`;

            const detailCard = (title, key) => {
                const obj = d[key] || { pay: 0, refund: 0 };
                const subTotal = obj.pay + obj.refund;
                return `<div class="bg-white rounded-2xl shadow-sm hover:shadow-lg transition-all duration-300 p-6 border border-gray-100">
                 <div class="flex justify-between mb-4 border-b border-gray-50 pb-3 items-center">
                     <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-primary/50"></div>${title}</h3>
                     <span class="text-lg font-bold ${subTotal < 0 ? 'text-red-600' : 'text-gray-800'}">${formatMoney(subTotal)}</span>
                 </div>
                 <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="cursor-pointer hover:bg-blue-50/50 p-2.5 rounded-xl transition border border-transparent hover:border-blue-100 group" onclick="openDetail('${key}','pay')">
                        <p class="text-[11px] text-gray-400 font-bold uppercase mb-1">ì§€ê¸‰</p>
                        <p class="text-base font-bold text-blue-600 group-hover:scale-105 transition-transform">${formatMoney(obj.pay)}</p>
                    </div>
                    <div class="cursor-pointer hover:bg-red-50/50 p-2.5 rounded-xl transition border border-transparent hover:border-red-100 group" onclick="openDetail('${key}','refund')">
                        <p class="text-[11px] text-gray-400 font-bold uppercase mb-1">í™˜ìˆ˜</p>
                        <p class="text-base font-bold text-red-500 group-hover:scale-105 transition-transform">${formatMoney(obj.refund)}</p>
                    </div>
                 </div></div>`;
            };

            div.innerHTML = `
             <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 tracking-tight">${state.user.name}ë‹˜ì˜ ì‹œìƒê¸ˆ (${state.currentMonth})</h2>
                <p class="text-gray-500 text-sm mt-1">í•´ë‹¹ ì›”ì˜ ì‹œìƒê¸ˆ ì§€ê¸‰ ë° í™˜ìˆ˜ í˜„í™©ì…ë‹ˆë‹¤.</p>
             </div>
             <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                 <div class="col-span-2 md:col-span-1">${card('ì‹¤ì§€ê¸‰ ì´ì•¡ (ì„¸ì „)', net, 'border-primary', false, true)}</div>
                 <div class="col-span-1">${card('ì´ ì§€ê¸‰ì•¡', totalPay, 'border-blue-500')}</div>
                 <div class="col-span-1">${card('ì´ í™˜ìˆ˜ì•¡', totalRef, 'border-red-500', true)}</div>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${detailCard('ì†ë³´ ì‹œìƒê¸ˆ', 'ì†ë³´ ì‹œìƒê¸ˆ')}
                ${detailCard('ìƒë³´ ì‹œìƒê¸ˆ', 'ìƒë³´ ì‹œìƒê¸ˆ')}
                ${detailCard('ë³¸ë¶€ ì‹œìƒê¸ˆ', 'ë³¸ë¶€ ì‹œìƒê¸ˆ')}
             </div>
             <div class="mt-8 text-center"><div class="inline-block px-4 py-2 bg-gray-100 rounded-xl md:rounded-full text-sm text-gray-500 font-medium select-none text-center">ğŸ’¡ Tip: ì§€ê¸‰/í™˜ìˆ˜ ê¸ˆì•¡ì„ í´ë¦­í•˜ë©´<br class="md:hidden"> ìƒì„¸ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>
             `;
            return div;
        }

        function createBranchView() {
            const div = document.createElement('div');
            const d = state.data.rewardData?.summary || {};
            // ë°±ì—”ë“œì˜ getRewardData í•¨ìˆ˜ ì •ì˜ì— ë§ì¶° ë‹¤ì‹œ ë¡¤ë°±
            const keys = ['ì†ë³´ ë²•ì¸ì‹œìƒê¸ˆ', 'ìƒë³´ ë²•ì¸ì‹œìƒê¸ˆ', '2ì°¨ë…„ ì¸ì„¼í‹°ë¸Œ'];
            let totalPay = 0, totalRef = 0;
            keys.forEach(k => { const obj = d[k] || { pay: 0, refund: 0 }; totalPay += obj.pay; totalRef += obj.refund; });
            const net = totalPay + totalRef;

            const card = (label, val, color, isRed = false, big = false) => `
              <div class="bg-white rounded-2xl shadow-sm p-6 border-l-4 ${color} flex flex-col justify-between h-full items-center text-center">
                 <p class="text-gray-400 text-xs w-full text-center font-bold uppercase">${label}</p>
                 <p class="${big ? 'text-2xl' : 'text-xl'} font-extrabold ${isRed || (val < 0) ? 'text-red-500' : 'text-gray-800'} mt-3 px-2">${formatMoney(val)}</p>
              </div>`;

            const detailCard = (title, key) => {
                const obj = d[key] || { pay: 0, refund: 0 };
                const subTotal = obj.pay + obj.refund;
                return `<div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                 <div class="flex justify-between mb-4 border-b border-gray-50 pb-2 items-center">
                     <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-primary/50"></div>${title}</h3>
                     <span class="text-lg font-bold ${subTotal < 0 ? 'text-red-600' : 'text-gray-800'}">${formatMoney(subTotal)}</span>
                 </div>
                 <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="cursor-pointer hover:bg-gray-50 p-2 rounded-xl transition" onclick="openDetail('${key}','pay')"><p class="text-[10px] text-gray-400 font-bold uppercase">ì§€ê¸‰</p><p class="text-lg font-bold text-blue-600">${formatMoney(obj.pay)}</p></div>
                    <div class="cursor-pointer hover:bg-gray-50 p-2 rounded-xl transition" onclick="openDetail('${key}','refund')"><p class="text-[10px] text-gray-400 font-bold uppercase">í™˜ìˆ˜</p><p class="text-lg font-bold text-red-500">${formatMoney(obj.refund)}</p></div>
                 </div></div>`;
            };

            div.innerHTML = `
            <div class="mb-6"><h2 class="text-xl font-bold text-gray-800">ì§€ì‚¬ëŒ€í‘œì˜ ì‹œìƒê¸ˆ (${state.currentMonth})</h2><p class="text-sm text-gray-500">ë²•ì¸ ì‹œìƒ ë° ì¸ì„¼í‹°ë¸Œ í˜„í™©</p></div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <div class="col-span-2 md:col-span-1">${card('ì‹¤ì§€ê¸‰ ì´ì•¡', net, 'border-primary', false, true)}</div>
                <div class="col-span-1">${card('ì´ ì§€ê¸‰ì•¡', totalPay, 'border-blue-500')}</div>
                <div class="col-span-1">${card('ì´ í™˜ìˆ˜ì•¡', totalRef, 'border-red-500', true)}</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
               ${detailCard('ì†ë³´ ë²•ì¸', 'ì†ë³´ ë²•ì¸ì‹œìƒê¸ˆ')}
               ${detailCard('ìƒë³´ ë²•ì¸', 'ìƒë³´ ë²•ì¸ì‹œìƒê¸ˆ')}
               ${detailCard('2ì°¨ë…„ ì¸ì„¼í‹°ë¸Œ', '2ì°¨ë…„ ì¸ì„¼í‹°ë¸Œ')}
            </div>`;
            return div;
        }

        function createRecruitmentView() {
            const div = document.createElement('div');
            const d = state.data.recData || { myStats: {}, downlines: [] };
            const groups = { 1: [], 2: [], 3: [], 4: [] };
            (d.downlines || []).forEach(x => { if (groups[x.level]) groups[x.level].push(x); });

            const calcItem = (item) => {
                const np = Number(item['ì†ë³´ì›”ë°œìƒë¶„'] || 0); const lp = Number(item['ìƒë³´ì›”ë°œìƒë¶„'] || 0);
                const nr = Number(item['ì†ë³´ì›”í™˜ìˆ˜ë¶„'] || 0); const lr = Number(item['ìƒë³´ì›”í™˜ìˆ˜ë¶„'] || 0);
                return { pay: np + lp, refund: nr + lr, net: np + lp + nr + lr };
            };
            let agg = { pay: 0, refund: 0, net: 0 };
            (d.downlines || []).forEach(item => { const res = calcItem(item); agg.pay += res.pay; agg.refund += res.refund; agg.net += res.net; });

            const card = (label, val, color, isRed = false, big = false) => `
              <div class="bg-white rounded-2xl shadow-sm p-5 border-l-4 ${color} flex flex-col justify-between h-full items-center text-center">
                 <p class="text-gray-400 text-xs w-full text-center font-bold uppercase">${label}</p>
                 <p class="${big ? 'text-2xl' : 'text-xl'} font-extrabold ${isRed || (val < 0) ? 'text-red-500' : 'text-gray-800'} mt-2">${formatMoney(val)}</p>
              </div>`;

            let listHtml = '';
            for (let i = 1; i <= 4; i++) {
                if (groups[i].length === 0) continue;
                const cards = groups[i].map(x => {
                    const s = calcItem(x);
                    return `<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition duration-200">
                    <div class="flex justify-between mb-3 items-center">
                        <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-primary/50"></div><span class="font-bold text-gray-900 text-lg">${x['ì´ë¦„']}</span></div>
                        <span class="font-bold text-gray-900 bg-gray-50 px-2 py-1 rounded text-lg">${formatMoney(s.net)}</span>
                    </div>
                    <div class="flex justify-between text-xs bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                       <div class="flex-1 text-center border-r border-gray-200">
                          <span class="text-gray-400 block mb-1 font-medium">ì§€ê¸‰</span>
                          <span class="text-blue-600 font-bold text-base">${formatMoney(s.pay)}</span>
                       </div>
                       <div class="flex-1 text-center">
                          <span class="text-gray-400 block mb-1 font-medium">í™˜ìˆ˜</span>
                          <span class="text-red-500 font-bold text-base">${formatMoney(s.refund)}</span>
                       </div>
                    </div></div>`;
                }).join('');
                listHtml += `<div class="mb-8"><h4 class="font-bold text-gray-600 mb-3 text-sm bg-gray-100/80 px-3 py-2 rounded-lg inline-block">${i}ì°¨ ì‚°í•˜ <span class="text-primary ml-1">${groups[i].length}ëª…</span></h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div></div>`;
            }

            div.innerHTML = `
             <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800">${state.user.name}ë‹˜ì˜ ì¦ì›ìˆ˜ë‹¹ (${state.currentMonth})</h2>
                <p class="text-gray-500 text-sm mt-1">ì¦ì›ìˆ˜ë‹¹ ë° ì°¨ìˆ˜ë³„ ì‚°í•˜ì¸ì› í˜„í™©ì…ë‹ˆë‹¤.</p>
             </div>
             <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <div class="col-span-2 md:col-span-1">${card('ë‚˜ì˜ ì¦ì›ìˆ˜ë‹¹ (ì„¸ì „)', agg.net, 'border-primary', false, true)}</div>
                <div class="col-span-1 md:col-span-1">${card('ì´ ì§€ê¸‰ì•¡', agg.pay, 'border-blue-500')}</div>
                <div class="col-span-1 md:col-span-1">${card('ì´ í™˜ìˆ˜ì•¡', agg.refund, 'border-red-500', true)}</div>
             </div>
             ${listHtml}
             <div class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200 text-sm text-gray-600 leading-relaxed shadow-inner">
                <p class="font-bold mb-2 text-gray-800">â€» ì¦ì›ìˆ˜ë‹¹ ê´€ë ¨ ì•ˆë‚´</p>
                <p class="mb-4">ì¦ì›ìˆ˜ë‹¹ì€ ê´€ë¦¬ììˆ˜ë‹¹(ì˜¤ë²„ë¼ì´ë“œ)ì´ ì•„ë‹™ë‹ˆë‹¤.<br>
                ì¦ì›ìˆ˜ë‹¹ì€ ì‚°í•˜ì¸ì›ì˜ ì‹¤ì ê³¼ ì—°ê³„ë˜ì–´ ì •í™•í•˜ê²Œ ê³„ì‚°ë˜ê³  ìˆìŒì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.<br>
                ì¦ì›ìˆ˜ë‹¹ê³¼ ê´€ë ¨í•˜ì—¬ ê¶ê¸ˆí•˜ì‹  ë¶€ë¶„ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë°•ìš©ìˆ˜ ë³¸ë¶€ì¥ì—ê²Œ ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                
                <p class="font-bold mb-2 text-gray-800">â€» ì¦ì›ìˆ˜ë‹¹ ê³„ì‚°ì‹</p>
                <ul class="list-disc list-inside space-y-1 ml-1 text-gray-600">
                    <li><span class="font-semibold text-gray-700">ì†í•´ë³´í—˜</span> : ì‹ ê³„ì•½ë³´í—˜ë£Œ X 30%</li>
                    <li><span class="font-semibold text-gray-700">ìƒëª…ë³´í—˜</span> : ì§€ê¸‰ìˆ˜ìˆ˜ë£Œ X 2.25% (ìœ ì§€ìˆ˜ìˆ˜ë£Œ í¬í•¨)</li>
                </ul>
             </div>`;
            return div;
        }

        function createAdminView() {
            const div = document.createElement('div');
            const dd = state.data.adminSummary || {};
            if (dd.error) { div.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${dd.message}</div>`; return div; }
            let list = [];
            if (state.adminTab === 'reward') list = state.adminSubTab === 'active' ? (dd.reward?.active || []) : (dd.reward?.resigned || []);
            else list = dd.recruitment || [];

            const totalPages = Math.ceil(list.length / state.pageSize);
            const start = (state.adminPage - 1) * state.pageSize;
            const pageList = list.slice(start, start + state.pageSize);
            const th = (t) => `<th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">${t}</th>`;
            // Updated td to accept onClick string
            const td = (v, c = '', onClickStr = '') => `<td class="px-3 py-3 text-right ${c} font-medium text-sm tabular-nums ${onClickStr ? 'cursor-pointer hover:bg-gray-100 underline decoration-dotted decoration-gray-300 underline-offset-4' : ''}" ${onClickStr ? `onclick="${onClickStr}"` : ''}>${formatMoney(v)}</td>`;

            div.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between mb-6 items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800 self-start sm:self-center">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (${state.currentMonth})</h2>
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg self-start sm:self-center">
                    <button onclick="setAT('reward')" class="px-4 py-2 text-sm rounded-md transition duration-200 ${state.adminTab === 'reward' ? 'bg-white shadow-sm text-primary font-bold' : 'text-gray-500 hover:text-gray-700'}">ì‹œìƒê¸ˆ</button>
                    ${state.user.role !== 'ê´€ë¦¬ì' ? `<button onclick="setAT('recruitment')" class="px-4 py-2 text-sm rounded-md transition duration-200 ${state.adminTab === 'recruitment' ? 'bg-white shadow-sm text-primary font-bold' : 'text-gray-500 hover:text-gray-700'}">ì¦ì›ìˆ˜ë‹¹</button>` : ''}
                </div>
            </div>
            ${state.adminTab === 'reward' ? `
            <div class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-6">
                    <button onclick="setST('active')" class="${state.adminSubTab === 'active' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'} whitespace-nowrap py-3 border-b-2 font-medium text-sm transition">ìœ„ì´‰ì (${dd.reward?.active?.length || 0})</button>
                    ${state.user.role !== 'ê´€ë¦¬ì' ? `<button onclick="setST('resigned')" class="${state.adminSubTab === 'resigned' ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700'} whitespace-nowrap py-3 border-b-2 font-medium text-sm transition">í•´ì´‰ì (${dd.reward?.resigned?.length || 0})</button>` : ''}
                </nav>
            </div>` : ''}
            <div class="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 whitespace-nowrap">
                   <thead class="bg-gray-50"><tr>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">ì´ë¦„</th>
                      ${state.adminTab === 'reward' ? th('ì†ë³´(ì§€ê¸‰)') + th('ì†ë³´(í™˜ìˆ˜)') + th('ìƒë³´(ì§€ê¸‰)') + th('ìƒë³´(í™˜ìˆ˜)') + th('ë³¸ë¶€(ì§€ê¸‰)') + th('ë³¸ë¶€(í™˜ìˆ˜)') : th('ì†ë³´ì¦ì›(ì§€ê¸‰)') + th('ì†ë³´ì¦ì›(í™˜ìˆ˜)') + th('ìƒë³´ì¦ì›(ì§€ê¸‰)') + th('ìƒë³´ì¦ì›(í™˜ìˆ˜)')}
                      <th class="px-4 py-3 text-right font-bold text-gray-800 bg-gray-100/50">í•©ê³„</th>
                   </tr></thead>
                   <tbody class="divide-y divide-gray-200 bg-white">
                      ${pageList.map(u => {
                let total = 0;
                if (state.adminTab === 'reward') total = (u.nlPay || 0) + (u.nlRef || 0) + (u.lPay || 0) + (u.lRef || 0) + (u.hqPay || 0) + (u.hqRef || 0);
                else total = (u.nlPay || 0) + (u.nlRef || 0) + (u.lPay || 0) + (u.lRef || 0);

                const cols = state.adminTab === 'reward'
                    ? td(u.nlPay, 'text-blue-600', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ì†ë³´ ì‹œìƒê¸ˆ', 'pay')`)
                    + td(u.nlRef, 'text-red-500', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ì†ë³´ ì‹œìƒê¸ˆ', 'refund')`)
                    + td(u.lPay, 'text-blue-600', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ìƒë³´ ì‹œìƒê¸ˆ', 'pay')`)
                    + td(u.lRef, 'text-red-500', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ìƒë³´ ì‹œìƒê¸ˆ', 'refund')`)
                    + td(u.hqPay, 'text-blue-600', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ë³¸ë¶€ ì‹œìƒê¸ˆ', 'pay')`)
                    + td(u.hqRef, 'text-red-500', `fetchAndShowAdminDetail('${u.id}', '${u.name}', 'ë³¸ë¶€ ì‹œìƒê¸ˆ', 'refund')`)
                    : td(u.nlPay, 'text-blue-600') + td(u.nlRef, 'text-red-500') + td(u.lPay, 'text-blue-600') + td(u.lRef, 'text-red-500');

                const nameContent = `${u.name} <span class="text-xs text-gray-400 font-normal">(${u.id})</span>`;
                const nameCell = state.adminTab === 'recruitment'
                    ? `<td class="px-4 py-3 font-semibold text-blue-600 text-center cursor-pointer hover:underline decoration-blue-300 underline-offset-4" onclick="fetchAndShowOrgTree('${u.id}', '${u.name}')">${nameContent}</td>`
                    : `<td class="px-4 py-3 font-semibold text-gray-900 text-center">${nameContent}</td>`;

                return `<tr class="hover:bg-gray-50 transition">${nameCell}${cols}<td class="px-4 py-3 text-right font-bold ${total < 0 ? 'text-red-500' : 'text-gray-900'} bg-gray-50/30">${formatMoney(total)}</td></tr>`;
            }).join('')}
                   </tbody>
                </table>
                </div>
                ${pageList.length === 0 ? '<div class="p-12 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>' : ''}
            </div>
            <div class="flex justify-center items-center mt-6 space-x-2">
                 <button ${state.adminPage === 1 ? 'disabled' : ''} onclick="setPage(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed transition text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                 <span class="px-4 py-2 text-sm text-gray-600 font-medium bg-gray-100 rounded-lg">${state.adminPage} / ${totalPages || 1}</span>
                 <button ${state.adminPage >= totalPages ? 'disabled' : ''} onclick="setPage(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed transition text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
             </div>`;
            return div;
        };
        function setAT(t) { state.adminTab = t; state.adminPage = 1; render(); }
        function setST(t) { state.adminSubTab = t; state.adminPage = 1; render(); }
        function setPage(d) { state.adminPage += d; render(); }


        // --- 7. Modals & Popups ---
        // --- 7. Modals & Popups ---
        window.openDetail = function (k, t, customDetails = null, customTitle = null) {
            let d = [];
            if (customDetails) {
                // If custom details provided (e.g. from Admin view), filter it if needed or use as is
                // The backend returns 'details' array for that user, so we filter by category and type just like normal
                d = customDetails.filter(x => x.category === k && x.type === t);
            } else {
                d = (state.data.rewardData?.details || []).filter(x => x.category === k && x.type === t);
            }

            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in";

            // Rate Calculation: (Amount / Premium) * 100
            const calcRate = (amt, prem) => {
                if (!prem || prem == 0) return '0%';
                return ((amt / prem) * 100).toFixed(1) + '%';
            };

            const rows = d.length ? d.map(x => `
             <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
               <td class="p-3 text-gray-700">${x.company}</td>
               <td class="p-3 text-xs text-gray-500 font-mono">${x.policyNo}</td>
               <td class="p-3 font-medium text-gray-800"><div class="truncate-product" title="${x.product}">${x.product}</div></td>
               <td class="p-3 text-xs text-gray-500">${x.date}</td>
               <td class="p-3 text-right font-medium text-gray-700">${formatMoney(x.premium)}</td>
               <td class="p-3 text-center text-gray-700">${x.customer}</td>
               <td class="p-3 text-right font-bold ${x.amount > 0 ? 'text-blue-600' : 'text-red-500'}">${formatMoney(x.amount)}</td>
               <td class="p-3 text-right text-xs bg-gray-50 font-mono text-gray-600">${calcRate(Math.abs(x.amount), x.premium)}</td>
               <td class="p-3 text-xs text-gray-500 max-w-[200px] truncate" title="${x.desc}">${x.desc}</td>
             </tr>`).join('') : '<tr><td colspan="9" class="p-8 text-center text-gray-500">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';

            const titlePrefix = customTitle ? `<span class="text-gray-500 mr-2">[${customTitle}]</span>` : '';

            modal.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl flex flex-col max-h-[90vh] overflow-hidden transform transition-all scale-100 ring-1 ring-black/5">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="font-bold text-xl text-gray-800 flex items-center gap-3">
                        <span class="w-1.5 h-6 bg-primary rounded-full block shadow-sm"></span>
                        <span>${titlePrefix}${k} <span class="${t === 'pay' ? 'text-blue-600' : 'text-red-500'}">${t === 'pay' ? 'ì§€ê¸‰' : 'í™˜ìˆ˜'}</span> ìƒì„¸ë‚´ì—­</span>
                    </h3>
                    <button class="close p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="overflow-auto flex-grow bg-white">
                    <table class="w-full text-sm whitespace-nowrap">
                        <thead class="bg-gray-100/80 sticky top-0 z-10 shadow-sm backdrop-blur-sm"><tr class="text-left text-gray-600">
                            <th class="p-3 font-semibold">ë³´í—˜ì‚¬</th>
                            <th class="p-3 font-semibold">ì¦ê¶Œë²ˆí˜¸</th>
                            <th class="p-3 font-semibold">ìƒí’ˆëª…</th>
                            <th class="p-3 font-semibold">ê³„ì•½ì¼</th>
                            <th class="p-3 text-right font-semibold">ë³´í—˜ë£Œ</th>
                            <th class="p-3 text-center font-semibold">ê³„ì•½ì</th>
                            <th class="p-3 text-right font-semibold">ë³´í—˜ì‚¬ì‹œìƒ</th>
                            <th class="p-3 text-right font-semibold">ì‹œìƒìœ¨(%)</th>
                            <th class="p-3 font-semibold">ì‹œìƒë‚´ìš©</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-100 text-right">
                    <button class="close px-6 py-2.5 bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-xl shadow-lg shadow-gray-200 transition">ë‹«ê¸°</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            modal.querySelectorAll('.close').forEach(b => b.onclick = () => modal.remove());
        }

        window.fetchAndShowAdminDetail = async function (id, name, category, type) {
            showLoading(true);
            const d = await callApi('getRewardData', id, state.currentMonth);
            showLoading(false);

            if (d && !d.error) {
                if (d.details) {
                    openDetail(category, type, d.details, name);
                } else {
                    alert('ìƒì„¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + (d.message || 'Unknown Error'));
            }
        };

        window.fetchAndShowOrgTree = async function (targetId, targetName) {
            showLoading(true);
            const res = await callApi('getOrgTree', state.user.staffId, targetId, state.currentMonth);
            showLoading(false);

            if (res.error) {
                alert('ì˜¤ë¥˜: ' + res.message);
            } else {
                showOrgTreeModal(res.data, targetName);
            }
        };

        window.showOrgTreeModal = function (data, targetName) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in";

            // Build Tree Logic
            const list = data.downlines || [];
            // Sort to ensure hierarchy (this does not guarantee full tree order but helps if sorted by levels)
            // Better approach: Reconstruct tree

            const buildTree = () => {
                const nodeMap = {};
                list.forEach(n => nodeMap[String(n['ì‚¬ë²ˆ'])] = { ...n, children: [] });

                const hierarchy = [];

                list.forEach(n => {
                    if (n.level === 1) {
                        hierarchy.push(nodeMap[String(n['ì‚¬ë²ˆ'])]);
                    } else {
                        // For levels > 1, parent is always the direct upline (ìƒìœ„1ì°¨)
                        const parentId = String(n['ìƒìœ„1ì°¨']);

                        if (nodeMap[parentId]) {
                            nodeMap[parentId].children.push(nodeMap[String(n['ì‚¬ë²ˆ'])]);
                        } else {
                            // Orphaned node (parent missing from list)?
                            // Add to root level to ensure visibility
                            hierarchy.push(nodeMap[String(n['ì‚¬ë²ˆ'])]);
                        }
                    }
                });
                return hierarchy;
            };

            const tree = buildTree();

            // Render Function
            const renderNode = (node) => {
                const pay = (Number(node['ì†ë³´ì›”ë°œìƒë¶„'] || 0) + Number(node['ìƒë³´ì›”ë°œìƒë¶„'] || 0));
                const ref = (Number(node['ì†ë³´ì›”í™˜ìˆ˜ë¶„'] || 0) + Number(node['ìƒë³´ì›”í™˜ìˆ˜ë¶„'] || 0));
                const net = pay + ref;
                const netClass = net >= 0 ? 'text-blue-600' : 'text-red-500';

                let html = `
                <div class="mb-2">
                    <div class="flex items-center p-3 bg-gray-50 rounded-xl hover:bg-white hover:shadow-md transition border border-gray-100/50">
                        <div class="flex-shrink-0 mr-3">
                            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-xs font-bold text-gray-500 shadow-sm">${node.level}ì°¨</div>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="text-sm font-bold text-gray-800 truncate">${node['ì´ë¦„']} <span class="text-gray-400 font-normal text-xs">(${node['ì‚¬ë²ˆ']})</span></p>
                            <p class="text-xs text-gray-500 truncate">${node['ì†Œì†'] || ''} | ${node['ì§ì±…'] || ''} | ${node['ìœ„ì´‰ì›”'] || ''}</p>
                        </div>
                        <div class="flex-shrink-0 text-right ml-3">
                            <p class="text-sm font-bold ${netClass}">${formatMoney(net)}</p>
                            <p class="text-[10px] text-gray-400">ì§€ê¸‰ ${formatMoney(pay)} / í™˜ìˆ˜ ${formatMoney(ref)}</p>
                        </div>
                    </div>
                `;

                if (node.children && node.children.length > 0) {
                    html += `<div class="ml-6 pl-4 border-l-2 border-gray-100 mt-2 space-y-2">`;
                    node.children.forEach(child => {
                        html += renderNode(child);
                    });
                    html += `</div>`;
                }

                html += `</div>`;
                return html;
            };

            let contentHtml = '';
            if (tree.length === 0) contentHtml = '<div class="text-center py-10 text-gray-400">ì‚°í•˜ ì¡°ì§ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            else tree.forEach(node => contentHtml += renderNode(node));

            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 backdrop-blur-md sticky top-0 z-10">
                        <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                            <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg></span>
                            <span>${targetName} <span class="text-gray-400 font-normal text-sm">ì‚°í•˜ ì¡°ì§ë„</span></span>
                        </h3>
                        <button class="close p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div class="p-6 overflow-y-auto bg-white custom-scrollbar">
                        ${contentHtml}
                    </div>
                     <div class="p-4 bg-gray-50 border-t border-gray-100 text-right">
                        <button class="close px-6 py-2.5 bg-gray-800 hover:bg-gray-900 text-white font-medium rounded-xl shadow-lg shadow-gray-200 transition">ë‹«ê¸°</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.querySelectorAll('.close').forEach(b => b.onclick = () => modal.remove());
        };

        // --- 8. Logic Interactions ---
        async function doLogin(id, pw) {
            showLoading(true);
            const r = await callApi('loginUser', id, pw);
            showLoading(false);

            if (r.success) {
                state.user = r.user;
                if (r.months && r.months.length > 0) {
                    state.months = r.months;
                    state.currentMonth = r.currentMonth || r.months[0];
                } else {
                    const now = new Date(); state.months = [String(now.getFullYear()) + String(now.getMonth() + 1).padStart(2, '0')];
                    state.currentMonth = state.months[0];
                }
                if (r.dashboardData) state.data.rewardData = r.dashboardData;

                if (state.user.isFirstLogin) {
                    openChangePasswordModal(false);
                } else {
                    saveSession();
                    navigate('home');
                }
            } else {
                alert(r.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }
        }

        function logout() {
            state.user = null;
            clearSession();
            navigate('login');
        }

        function refresh() {
            if (!state.user) return;

            // [OPTIMIZATION] Client-side caching
            const cacheKey = `DATA_${state.user.staffId}_${state.currentMonth}_${state.currentView}`;

            // 1. Check Memory State
            if (state.currentView === 'home' && state.data.homeData) { render(); return; }
            if (state.currentView === 'dashboard' && state.data.rewardData?.month === state.currentMonth) { render(); return; }
            if (state.currentView === 'recruitment' && state.data.recData?.month === state.currentMonth) { render(); return; }
            if (state.currentView === 'branch' && state.data.rewardData?.month === state.currentMonth) { render(); return; }

            // 2. Check Session Storage
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const parsed = JSON.parse(cached);
                    // Update State
                    if (state.currentView === 'home') state.data.homeData = parsed;
                    else if (state.currentView === 'dashboard' || state.currentView === 'branch') state.data.rewardData = parsed;
                    else if (state.currentView === 'recruitment') state.data.recData = parsed;
                    else if (state.currentView === 'admin') state.data.adminSummary = parsed;

                    render();
                    return; // Skip fetch
                } catch (e) {
                    sessionStorage.removeItem(cacheKey);
                }
            }

            if (state.currentView === 'home') fetchHome(cacheKey);
            else if (state.currentView === 'dashboard' || state.currentView === 'branch') fetchReward(cacheKey);
            else if (state.currentView === 'recruitment') fetchRec(cacheKey);
            else if (state.currentView === 'admin') fetchAdmin(cacheKey);
        }

        async function fetchHome(key) {
            showLoading(true);
            const d = await callApi('getHomeData', state.user.staffId);
            showLoading(false);

            if (!d.error && d.success) {
                state.data.homeData = d;
                sessionStorage.setItem(key, JSON.stringify(d));
                render();
            } else {
                state.data.homeData = { retentionRate: 'ë°ì´í„° ì—†ìŒ', baseMonth: '-' };
                render();
            }
        }

        async function fetchReward(key) {
            showLoading(true);
            const d = await callApi('getRewardData', state.user.staffId, state.currentMonth);
            showLoading(false);

            if (!d.error) {
                d.month = state.currentMonth;
                state.data.rewardData = d;
                sessionStorage.setItem(key, JSON.stringify(d));
                render();
            } else {
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + d.message);
            }
        }
        async function fetchRec(key) {
            showLoading(true);
            const d = await callApi('getRecruitmentData', state.user.staffId, state.currentMonth);
            showLoading(false);

            if (!d.error) {
                d.month = state.currentMonth;
                state.data.recData = d;
                sessionStorage.setItem(key, JSON.stringify(d));
                render();
            } else {
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + d.message);
            }
        }
        async function fetchAdmin(key) {
            showLoading(true);
            const d = await callApi('getAdminSummary', state.currentMonth, state.user.staffId);
            showLoading(false);

            let parsed = d;
            // Handle double JSON parsing if necessary (sometimes GAS returns stringified JSON)
            if (typeof d === 'string') {
                try { parsed = JSON.parse(d); } catch (e) { parsed = { error: true, message: 'JSON Parse Error' }; }
            }

            state.data.adminSummary = parsed;
            if (!parsed.error && key) sessionStorage.setItem(key, JSON.stringify(parsed));
            render();
        }

        // --- 9. Password Change ---
        function openChangePasswordModal(canCancel) {
            const m = document.getElementById('pw-modal');
            m.classList.remove('hidden');
            const cancelBtn = document.getElementById('pwCancelBtn');
            // Show/Hide cancel button (it's the first button in the div usually, or select by ID)
            if (cancelBtn) cancelBtn.style.visibility = canCancel ? 'visible' : 'hidden'; // Don't remove from layout to keep alignment? Or display none.
            if (cancelBtn) cancelBtn.style.display = canCancel ? 'block' : 'none';
        }

        function closePwModal() { document.getElementById('pw-modal').classList.add('hidden'); }

        document.getElementById('pwForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const p1 = document.getElementById('newPw').value;
            const p2 = document.getElementById('confirmPw').value;
            if (p1 !== p2) { alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
            if (p1.length < 4) { alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }

            showLoading(true);
            const res = await callApi('changePassword', state.user.staffId, p1);
            showLoading(false);

            if (res.success) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                closePwModal();
                logout();
            } else {
                alert('ì‹¤íŒ¨: ' + (res.message || 'Unknown Error'));
            }
        });

        // --- 10. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if already on a specific route without session
            if (restoreSession()) {
                refresh();
            } else {
                render(); // shows login
            }
        });

    </script>
</body>

</html>
